class AeolusChecker {
    constructor() {
        this.running = false;
        this.stats = {
            checked: 0,
            lives: 0,
            deads: 0
        };
        this.init();
    }

    init() {
        this.elements = {
            checkBtn: document.getElementById('checkBtn'),
            clearBtn: document.getElementById('clearBtn'),
            cardsInput: document.getElementById('cards'),
            gateway: document.getElementById('gateway'),
            livesList: document.getElementById('livesList'),
            deadsList: document.getElementById('deadsList'),
            checkedCount: document.getElementById('checkedCount'),
            livesCount: document.getElementById('livesCount'),
            deadsCount: document.getElementById('deadsCount'),
            successRate: document.getElementById('successRate'),
            loadingOverlay: document.getElementById('loadingOverlay')
        };

        this.bindEvents();
        this.initCanvas();
    }

    bindEvents() {
        this.elements.checkBtn.addEventListener('click', () => this.startChecking());
        this.elements.clearBtn.addEventListener('click', () => this.clearAll());
    }

    initCanvas() {
        const canvas = document.getElementById('bgCanvas');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        
        const resize = () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        };
        
        window.addEventListener('resize', resize);
        resize();

        const particles = Array.from({length: 50}, () => ({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            size: Math.random() * 2 + 1,
            speedX: Math.random() * 2 - 1,
            speedY: Math.random() * 2 - 1,
            color: `rgba(79, 70, 229, ${Math.random() * 0.3})`
        }));

        const animate = () => {
            requestAnimationFrame(animate);
            ctx.fillStyle = 'rgba(11, 15, 26, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            particles.forEach(p => {
                p.x += p.speedX;
                p.y += p.speedY;

                if(p.x < 0 || p.x > canvas.width) p.speedX *= -1;
                if(p.y < 0 || p.y > canvas.height) p.speedY *= -1;

                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fillStyle = p.color;
                ctx.fill();
            });
        };

        animate();
    }

    async startChecking() {
        const cards = this.elements.cardsInput.value
            .split('\n')
            .map(card => card.trim())
            .filter(card => card);

        if(!cards.length || cards.length > 20) {
            this.showNotification('Ingresa entre 1 y 20 tarjetas', 'error');
            return;
        }

        this.running = true;
        this.elements.checkBtn.disabled = true;
        this.elements.loadingOverlay.style.display = 'flex';
        this.resetCounters();

        for(const card of cards) {
            if(!this.running) break;
            await this.checkCard(card);
            await new Promise(r => setTimeout(r, 2000));
        }

        this.running = false;
        this.elements.checkBtn.disabled = false;
        this.elements.loadingOverlay.style.display = 'none';
        this.showNotification('Proceso completado', 'success');
    }

    async checkCard(card) {
        try {
            const gateway = this.elements.gateway.value;
            const response = await fetch(`/api/${gateway}/check`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({cards: [card]})
            });

            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }

            const result = await response.json();
            
            if(result.success && result.results[0]) {
                this.stats.checked++;
                const cardResult = result.results[0];
                
                if(cardResult.status === 'Live' && !cardResult.message?.includes('Unable')) {
                    await this.addCard('live', card, cardResult);
                    this.stats.lives++;
                } else {
                    await this.addCard('dead', card, {
                        message: cardResult.message || 'Card Declined',
                        bank: cardResult.card?.bank || 'Unknown Bank',
                        country: cardResult.card?.country || { name: 'Unknown', emoji: 'üåç' }
                    });
                    this.stats.deads++;
                }
                
                this.updateStats();
            }
        } catch(error) {
            console.error('Check error:', error);
            await this.addCard('dead', card, {
                message: `Card Declined | .gg/aeolous`,
                bank: 'Gateway Error',
                country: { name: 'Error', emoji: '‚ö†Ô∏è' }
            });
        }
    }

    async addCard(type, card, result) {
        const div = document.createElement('div');
        div.className = `card-item ${type}`;
        
        let status = type === 'live' ? 'LIVE' : 'DEAD';
        let capture = result.capture || null;

        div.innerHTML = `
            <div class="card-content">
                <div class="card-header">
                    <div class="card-number sensitive-data">
                        ${card}
                    </div>
                    <button class="copy-btn" onclick="copyToClipboard('${card} | ${status} | ${
                        result.bank || 'Unknown'} | ${result.country?.emoji || 'üåç'} | .gg/aeolous')">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
                <div class="card-status">
                    <span class="status-badge ${type}">
                        <i class="fas fa-${type === 'live' ? 'check' : 'times'}-circle"></i>
                        ${status}
                    </span>
                    <span class="card-details-inline">
                        ${result.message || ''} | ${result.bank || 'Unknown Bank'} | ${
                            result.country?.emoji || 'üåç'} | .gg/aeolous
                    </span>
                </div>
            </div>
        `;
        
        this.elements[type === 'live' ? 'livesList' : 'deadsList'].appendChild(div);
        div.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }

    updateStats() {
        this.elements.checkedCount.textContent = this.stats.checked;
        this.elements.livesCount.textContent = this.stats.lives;
        this.elements.deadsCount.textContent = this.stats.deads;
        
        const rate = this.stats.checked ? 
            ((this.stats.lives / this.stats.checked) * 100).toFixed(1) : '0.0';
        this.elements.successRate.textContent = `${rate}%`;
    }

    resetCounters() {
        this.stats = {checked: 0, lives: 0, deads: 0};
        this.updateStats();
        this.elements.livesList.innerHTML = '';
        this.elements.deadsList.innerHTML = '';
    }

    clearAll() {
        this.elements.cardsInput.value = '';
        this.resetCounters();
        this.showNotification('Resultados limpiados', 'info');
    }

    showNotification(message, type = 'info') {
        const notifications = document.querySelector('.notifications') || (() => {
            const div = document.createElement('div');
            div.className = 'notifications';
            document.body.appendChild(div);
            return div;
        })();

        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <i class="fas fa-${
                type === 'success' ? 'check-circle' : 
                type === 'error' ? 'times-circle' : 
                'info-circle'
            }"></i>
            <span>${message}</span>
        `;

        notifications.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }
}

// Funci√≥n global para copiar
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        const notification = document.createElement('div');
        notification.className = 'notification success';
        notification.innerHTML = `
            <i class="fas fa-check"></i>
            CC Copiada
        `;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 2000);
    }).catch(err => {
        console.error('Error al copiar:', err);
    });
}

// Inicializar cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', () => {
    window.checker = new AeolusChecker();
});
