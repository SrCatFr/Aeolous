// script.js (sin ofuscar)
class AeolusChecker {
    constructor() {
        this.running = false;
        this.stats = {
            checked: 0,
            lives: 0,
            deads: 0
        };
        this.init();
    }

    init() {
        // Inicializar elementos
        this.elements = {
            checkBtn: document.getElementById('checkBtn'),
            clearBtn: document.getElementById('clearBtn'),
            cardsInput: document.getElementById('cards'),
            gateway: document.getElementById('gateway'),
            livesList: document.getElementById('livesList'),
            deadsList: document.getElementById('deadsList'),
            checkedCount: document.getElementById('checkedCount'),
            livesCount: document.getElementById('livesCount'),
            deadsCount: document.getElementById('deadsCount'),
            successRate: document.getElementById('successRate'),
            loadingOverlay: document.getElementById('loadingOverlay')
        };

        // Bind eventos
        this.elements.checkBtn.addEventListener('click', () => this.startChecking());
        this.elements.clearBtn.addEventListener('click', () => this.clearAll());
    }

    async startChecking() {
        const cards = this.elements.cardsInput.value
            .split('\n')
            .map(card => card.trim())
            .filter(card => card);

        if(!cards.length || cards.length > 20) {
            this.showNotification('Ingresa entre 1 y 20 tarjetas', 'error');
            return;
        }

        this.running = true;
        this.elements.checkBtn.disabled = true;
        this.elements.loadingOverlay.style.display = 'flex';
        this.resetCounters();

        for(const card of cards) {
            if(!this.running) break;
            await this.checkCard(card);
            await new Promise(r => setTimeout(r, 2000));
        }

        this.running = false;
        this.elements.checkBtn.disabled = false;
        this.elements.loadingOverlay.style.display = 'none';
    }

    async checkCard(card) {
        try {
            const gateway = this.elements.gateway.value;
            const response = await fetch(`/api/${gateway}/check`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({cards: [card]})
            });

            const result = await response.json();

            if(result.success && result.results[0]) {
                this.stats.checked++;
                const cardResult = result.results[0];

                if(cardResult.status === 'Live' && !cardResult.message?.includes('Unable')) {
                    await this.addCard('live', card, cardResult);
                    this.stats.lives++;
                } else {
                    await this.addCard('dead', card, cardResult);
                    this.stats.deads++;
                }

                this.updateStats();
            }
        } catch(error) {
            this.addCard('dead', card, {message: 'Error de conexión'});
        }
    }

    addCard(type, card, result) {
        const div = document.createElement('div');
        div.className = `card-item ${type}`;

        let status = type === 'live' ? 'LIVE' : 'DEAD';
        let capture = result.capture || null;
        const discord = '.gg/aeolous';

        div.innerHTML = `
            <div class="card-content">
                <div class="card-header">
                    <div class="card-number sensitive-data">
                        ${card}
                    </div>
                    <button class="copy-btn" onclick="copyToClipboard('${card} | ${result.message || status} | ${
                        capture ? `${capture.bank} | ${capture.country.emoji}` : ''
                    } | ${discord}')">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
                <div class="card-status">
                    <span class="status-badge ${type}">
                        <i class="fas fa-${type === 'live' ? 'check' : 'times'}-circle"></i>
                        ${status}
                    </span>
                    <span class="card-details-inline">
                        ${result.message || ''} ${
                            capture ? 
                            `| ${capture.bank} | ${capture.country.emoji} | ${discord}` : 
                            `| ${discord}`
                        }
                    </span>
                </div>
                ${capture ? `
                    <div class="card-details">
                        <div class="detail-item">
                            <i class="fas fa-university"></i>
                            ${capture.bank}
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-credit-card"></i>
                            ${capture.type}
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-globe"></i>
                            ${capture.country.emoji} ${capture.country.name}
                        </div>
                        <div class="detail-item discord">
                            <i class="fab fa-discord"></i>
                            ${discord}
                        </div>
                    </div>
                ` : ''}
            </div>
        `;

        this.elements[type === 'live' ? 'livesList' : 'deadsList'].appendChild(div);
    }

    updateStats() {
        this.elements.checkedCount.textContent = this.stats.checked;
        this.elements.livesCount.textContent = this.stats.lives;
        this.elements.deadsCount.textContent = this.stats.deads;

        const rate = this.stats.checked ? 
            ((this.stats.lives / this.stats.checked) * 100).toFixed(1) : '0.0';
        this.elements.successRate.textContent = `${rate}%`;
    }

    resetCounters() {
        this.stats = {checked: 0, lives: 0, deads: 0};
        this.updateStats();
        this.elements.livesList.innerHTML = '';
        this.elements.deadsList.innerHTML = '';
    }

    clearAll() {
        this.elements.cardsInput.value = '';
        this.resetCounters();
    }
    // Agregar al final del script.js

    showNotification(message, type) {
        // Implementar si se desea
        console.log(`${type}: ${message}`);
    }
}

// Inicializar cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', () => {
    window.checker = new AeolusChecker();
});

// Agregar al final del script.js
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // Mostrar notificación de copiado exitoso
        const notification = document.createElement('div');
        notification.className = 'copy-notification';
        notification.innerHTML = `
            <i class="fas fa-check"></i>
            CC Copiada
        `;
        document.body.appendChild(notification);

        // Remover notificación después de 2 segundos
        setTimeout(() => notification.remove(), 2000);
    }).catch(err => {
        console.error('Error al copiar:', err);
    });
}